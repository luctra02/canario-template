# ========================
#  HAProxy Configuration
#  Project Canario 2025
# ========================

global
    log /dev/log local0
    log /dev/log local1 notice
    maxconn 2048
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s

# === Frontend ===
frontend http_front
    bind *:80
    mode http

    # Route /flags to flag-proxy backend
    acl path_flags path_beg /flags
    use_backend flag_proxy_backend if path_flags

    # Default route -> web app
    default_backend canario_web_backend

# === Backend: Web ===
backend canario_web_backend
    mode http
    balance roundrobin
    option httpchk GET /
    server web1 192.168.47.100:8080 check

# === Backend: Feature Flag Proxy ===
backend flag_proxy_backend
    mode http
    option httpchk GET /flags
    server proxy1 192.168.47.100:9000 check

# === Stats Dashboard (optional) ===
listen stats
    bind *:1936
    mode http
    stats enable
    stats uri /
    stats refresh 10s
    stats auth admin:admin

